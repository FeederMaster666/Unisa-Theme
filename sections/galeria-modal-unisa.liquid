{% comment %}
Sección: Galería con modal dividido (estilo Unisa)
- Carrusel en la página (miniaturas)
- Al click, modal con 2 columnas:
  - Izquierda: slider de imágenes grande con navegación
  - Derecha: icono Instagram, textos, mini-foto, botón
Contenido editable desde el CMS (settings + blocks)
{% endcomment %}

<div id="UnisaGallery-{{ section.id }}" class="unisa-gallery" data-section-id="{{ section.id }}">
  <div class="unisa-gallery__track">
    {%- for block in section.blocks -%}
      {%- if block.type == 'image' and block.settings.image != blank -%}
        <button
          type="button"
          class="unisa-gallery__item"
          data-index="{{ forloop.index0 }}"
          aria-haspopup="dialog"
          aria-controls="UnisaGalleryModal-{{ section.id }}"
          {{ block.shopify_attributes }}>
          {{ block.settings.image
            | image_url: width: 600
            | image_tag:
              class: 'unisa-gallery__img',
              loading: 'lazy',
              sizes: '200px',
              widths: '200,300,400,600',
              alt: block.settings.image.alt | default: 'Galería'
          }}
        </button>
      {%- endif -%}
    {%- endfor -%}
  </div>
</div>

<div
  id="UnisaGalleryModal-{{ section.id }}"
  class="unisa-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="UnisaGalleryModalTitle-{{ section.id }}"
  hidden>
  <div class="unisa-modal__overlay" data-close></div>

  <div class="unisa-modal__dialog" tabindex="-1">
    <button class="unisa-modal__close" type="button" aria-label="Close" data-close>×</button>

    <div class="unisa-modal__content">
      <!-- Columna izquierda: slider -->
      <div class="unisa-modal__left">
        <div class="unisa-modal__slider" data-slider>
          {%- for block in section.blocks -%}
            {%- if block.type == 'image' and block.settings.image != blank -%}
              <div class="unisa-slide" data-slide>
                {{ block.settings.image
                  | image_url: width: 1400
                  | image_tag:
                    class: 'unisa-slide__img',
                    loading: 'eager',
                    sizes: '(min-width: 990px) 60vw, 100vw',
                    widths: '700,1000,1200,1400',
                    alt: block.settings.image.alt | default: 'Imagen ampliada'
                }}
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>

        <div class="unisa-modal__nav">
          <button type="button" class="unisa-nav__btn" data-prev aria-label="Anterior">‹</button>
          <button type="button" class="unisa-nav__btn" data-next aria-label="Siguiente">›</button>
        </div>
      </div>

      <!-- Columna derecha: info -->
      <aside class="unisa-modal__right">
        {%- if section.settings.ig_url != blank or section.settings.ig_label != blank -%}
          <a class="unisa-ig" href="{{ section.settings.ig_url }}" target="_blank" rel="noopener">
            <svg class="unisa-ig__icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2.2c3.2 0 3.6 0 4.9.1 1.2.1 1.9.2 2.4.4.6.2 1 .5 1.5 1 .5.5.8.9 1 1.5.2.5.3 1.2.4 2.4.1 1.3.1 1.7.1 4.9s0 3.6-.1 4.9c-.1 1.2-.2 1.9-.4 2.4-.2.6-.5 1-1 1.5-.5.5-.9.8-1.5 1-.5.2-1.2.3-2.4.4-1.3.1-1.7.1-4.9.1s-3.6 0-4.9-.1c-1.2-.1-1.9-.2-2.4-.4-.6-.2-1-.5-1.5-1-.5-.5-.8-.9-1-1.5-.2-.5-.3-1.2-.4-2.4C2.2 15.6 2.2 15.2 2.2 12s0-3.6.1-4.9c.1-1.2.2-1.9.4-2.4.2-.6.5-1 1-1.5.5-.5.9-.8 1.5-1 .5-.2 1.2-.3 2.4-.4C8.4 2.2 8.8 2.2 12 2.2zm0 1.8c-3.1 0-3.5 0-4.8.1-1 .1-1.6.2-2 .3-.5.2-.8.4-1.1.7-.3.3-.5.6-.7 1.1-.1.4-.2 1-.3 2-.1 1.3-.1 1.7-.1 4.8s0 3.5.1 4.8c.1 1 .2 1.6.3 2 .2.5.4.8.7 1.1.3.3.6.5 1.1.7.4.1 1 .2 2 .3 1.3.1 1.7.1 4.8.1s3.5 0 4.8-.1c1-.1 1.6-.2 2-.3.5-.2.8-.4 1.1-.7.3-.3.5-.6.7-1.1.1-.4.2-1 .3-2 .1-1.3.1-1.7.1-4.8s0-3.5-.1-4.8c-.1-1-.2-1.6-.3-2-.2-.5-.4-.8-.7-1.1-.3-.3-.6-.5-1.1-.7-.4-.1-1-.2-2-.3-1.3-.1-1.7-.1-4.8-.1zm0 3.3a6.7 6.7 0 1 1 0 13.4 6.7 6.7 0 0 1 0-13.4zm0 1.8a4.9 4.9 0 1 0 0 9.8 4.9 4.9 0 0 0 0-9.8zm5.5-2.2a1.3 1.3 0 1 1-2.6 0 1.3 1.3 0 0 1 2.6 0z"/>
            </svg>
            <span class="unisa-ig__label">{{ section.settings.ig_label | default: 'Instagram' }}</span>
          </a>
        {%- endif -%}

        {%- if section.settings.intro_text != blank -%}
          <p class="unisa-intro">{{ section.settings.intro_text }}</p>
        {%- endif -%}

        <hr class="unisa-divider" />

        {%- if section.settings.highlight_text != blank -%}
          <h3 id="UnisaGalleryModalTitle-{{ section.id }}" class="unisa-highlight">
            {{ section.settings.highlight_text }}
          </h3>
        {%- endif -%}

        {%- if section.settings.small_image != blank -%}
          <figure class="unisa-small">
            {{ section.settings.small_image
              | image_url: width: 300
              | image_tag: class: 'unisa-small__img', loading: 'lazy', alt: section.settings.small_image.alt | default: 'Detalle'
            }}
            {%- if section.settings.small_text != blank -%}
              <figcaption class="unisa-small__caption">{{ section.settings.small_text }}</figcaption>
            {%- endif -%}
          </figure>
        {%- endif -%}

        {%- if section.settings.cta_label != blank and section.settings.cta_link != blank -%}
          <a href="{{ section.settings.cta_link }}" class="button">{{ section.settings.cta_label }}</a>
        {%- endif -%}
      </aside>
    </div>
  </div>
</div>

{% stylesheet %}
.unisa-gallery {
  width: 100%;
  overflow: hidden;
  padding: 10px 0;
}
.unisa-gallery__track {
  display: flex; gap: 10px; overflow-x: auto; scroll-snap-type: x mandatory;
}
.unisa-gallery__item { background: transparent; border: 0; padding: 0; scroll-snap-align: start; cursor: pointer; }
.unisa-gallery__img { display: block; height: 120px; width: auto; border-radius: 4px; }

.unisa-modal[hidden] { display: none !important; }
.unisa-modal {
  position: fixed; inset: 0; z-index: 1000;
  display: flex; align-items: center; justify-content: center;
}
.unisa-modal__overlay {
  position: absolute; inset: 0; background: rgb(0 0 0 / 0.6);
}
.unisa-modal__dialog {
  position: relative; z-index: 1; background: #fff; width: min(1000px, 92vw); height: min(85vh, 900px);
  display: grid; grid-template-columns: 2fr 1fr; border-radius: 10px; overflow: hidden; box-shadow: var(--shadow-drawer, 0 20px 60px rgb(0 0 0 / .2));
  outline: none;
}
@media (max-width: 900px) {
  .unisa-modal__dialog { grid-template-columns: 1fr; height: 90vh; }
}
.unisa-modal__close {
  position: absolute; top: 8px; right: 10px; background: transparent; border: 0; font-size: 28px; line-height: 1; cursor: pointer; z-index: 2;
}

.unisa-modal__content { display: contents; }
.unisa-modal__left { position: relative; background: #000; display: grid; place-items: center; }
.unisa-modal__slider { width: 100%; height: 100%; position: relative; }
.unisa-slide { position: absolute; inset: 0; display: none; place-items: center; }
.unisa-slide__img { object-fit: contain; width: 100%; height: 100%; }
.unisa-modal__nav {
  position: absolute; inset-block: 0; inset-inline: 0; display: flex; align-items: center; justify-content: space-between; pointer-events: none; padding: 0 8px;
}
.unisa-nav__btn {
  pointer-events: all; background: rgb(255 255 255 / .8); border: 0; width: 38px; height: 38px; border-radius: 999px; cursor: pointer; font-size: 22px;
}
.unisa-modal__right { padding: 20px; display: grid; gap: 12px; align-content: start; }
.unisa-ig { display: inline-flex; gap: 8px; align-items: center; text-decoration: none; color: inherit; }
.unisa-ig__icon { width: 22px; height: 22px; }
.unisa-divider { border: 0; border-top: 1px solid #e6e6e6; margin: 8px 0; }
.unisa-small { display: grid; gap: 6px; justify-items: start; }
.unisa-small__img { width: 150px; height: auto; border-radius: 6px; }
{% endstylesheet %}

{% javascript %}
(() => {
  const root = document.querySelector('.unisa-gallery[data-section-id]');
  if (!root) return;
  const sectionId = root.getAttribute('data-section-id');
  const modal = document.getElementById('UnisaGalleryModal-' + sectionId);
  if (!modal) return;

  const slides = modal.querySelectorAll('[data-slide]');
  const dialog = modal.querySelector('.unisa-modal__dialog');
  const btnNext = modal.querySelector('[data-next]');
  const btnPrev = modal.querySelector('[data-prev]');
  let current = 0;

  function update() {
    slides.forEach((s, i) => { s.style.display = i === current ? 'grid' : 'none'; });
  }
  function open(index) {
    current = Number.isInteger(index) ? index : 0;
    modal.hidden = false;
    document.body.style.overflow = 'hidden';
    update();
    dialog && dialog.focus();
  }
  function close() {
    modal.hidden = true;
    document.body.style.overflow = '';
  }
  function next() { current = (current + 1) % slides.length; update(); }
  function prev() { current = (current - 1 + slides.length) % slides.length; update(); }

  root.querySelectorAll('.unisa-gallery__item').forEach(btn => {
    btn.addEventListener('click', () => open(parseInt(btn.dataset.index)));
  });

  modal.addEventListener('click', (e) => {
    if (e.target.closest('[data-close]')) close();
  });

  btnNext && btnNext.addEventListener('click', next);
  btnPrev && btnPrev.addEventListener('click', prev);

  modal.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowRight') next();
    if (e.key === 'ArrowLeft') prev();
  });
})();
{% endjavascript %}

{% schema %}
{
  "name": "Galería modal (Unisa)",
  "settings": [
    { "type": "text", "id": "ig_label", "label": "Texto Instagram"},
    { "type": "url",  "id": "ig_url",   "label": "URL Instagram"},
    { "type": "text", "id": "intro_text", "label": "Texto introductorio", "default": "Descubre nuestras últimas publicaciones." },
    { "type": "text", "id": "highlight_text", "label": "Frase destacada", "default": "Campaña Otoño / Invierno" },
    { "type": "image_picker", "id": "small_image", "label": "Imagen pequeña (columna derecha)" },
    { "type": "text", "id": "small_text", "label": "Texto bajo la imagen pequeña" },
    { "type": "url",  "id": "cta_link",  "label": "Enlace del botón" },
    { "type": "text", "id": "cta_label", "label": "Texto del botón", "default": "Ver más" }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Imagen de galería",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Imagen" }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [{ "name": "Galería modal (Unisa)", "category": "Secciones personalizadas" }]
}
{% endschema %}
